# TDDベースのテスト作成スキル（簡易版）

## 前提：TDDの基本ルール

- **Red**：先に「落ちるテスト」を1つ書き、仕様を決める
- **Green**：テストを通すための**最小限の実装だけ**を書く（作り込みすぎない）
- **Refactor**：すべてGreenの状態で、テスト／実装を安全にリファクタリング

> テストコード＝仕様書。テスト名と期待値を読めば仕様が分かる状態を目指す。

---

## テストの書き方：AAAパターン（Arrange-Act-Assert）

すべてのテストは以下の3セクションで書く：

```typescript
it('指定した金額でレコードを作成する', () => {
  // Arrange: 準備
  const input = { amount: 800 }
  const repository = new Repository()

  // Act: 実行
  const result = repository.create(input)

  // Assert: 検証
  expect(result.amount).toBe(800)
})
```

---

## 何からテストするか（テスト観点の優先度）

TDDでは、次の順番でテストを増やすことを推奨：

1. **正常系（Happy Path）**
   - 代表的な入力で期待どおり動くか
   - 必要なら最小限の境界値（0件・最小値など）

2. **異常系・エッジケース**
   - 不正な値：負の値、NaN、Infinity、空文字列 など
   - 存在しないID・空の状態・壊れたデータ など

3. **統合レベルの確認（必要に応じて）**
   - 他のクラス／リポジトリとの連携
   - トランザクションや一貫性
   - ※パフォーマンス・リソース制限・メモリリークなどの重いテストは  
     TDDループとは切り離し、別スイートとして必要なときだけ書く

---

## テストケース命名規則（仕様が伝わる名前）

```typescript
describe('Repository#create', () => {
  describe('正常系', () => {
    it('正の金額の場合はレコードを保存する', () => {})
  })

  describe('異常系', () => {
    it('負の金額の場合はエラーを投げる', () => {})
  })

  describe('境界値', () => {
    it('金額が0の場合も保存できる', () => {})
  })
})
```

- **テストケース名は原則日本語で書く**（仕様をそのまま一文で書くイメージ）
- 英語を使う場合も、「何をしたときにどうなるか」が一目で分かる文にする
- 内部実装ではなく「入力 → 結果」の振る舞いを表現する

---

## 代表的なテスト例（入力値検証）

```typescript
describe('Repository#create - 入力値検証', () => {
  it('負の金額の場合はエラーを投げる', () => {
    const repository = new Repository()
    const input = { amount: -100 }

    expect(() => repository.create(input)).toThrow()
  })

  it('NaNが渡された場合はエラーを投げる', () => {
    const repository = new Repository()
    const input = { amount: NaN }

    expect(() => repository.create(input)).toThrow()
  })
})
```

> 実際には「最初に1ケースだけ書いて Red → Green → Refactor」  
> を繰り返し、あとからケースを足していく。

---

## カバレッジ目標（目安）

- 行／分岐カバレッジ：**80％以上**
- 関数カバレッジ：**基本すべてテストを書く意識**
- ただし「数字を満たすため」ではなく、**仕様をテストで表現した結果として**カバレッジが上がるのが理想

---

## テスト実行コマンド（例）

```bash
# TDDループで使う
npm run test -- --watch

# 一括実行
npm run test

# カバレッジ
npm run test:coverage
```

---

## 運用ルール（チーム共通認識）

1. **必ずテストから書く（新規実装もバグ修正も）**
2. **1テスト1観点**を意識し、小さなサイクルでRed-Green-Refactorを回す
3. **テストは独立させる**：他テストの実行順／状態に依存しない
4. **外部依存はモックする**：DB・API・時間などは切り離してユニットを保つ
5. **内部実装に依存しないテストを書く**：公開インターフェイスを通して検証する
6. **重い統合テスト・パフォーマンステストはTDDループとは別に管理する**
