# 開発ルール

このプロジェクトで Claude Code が開発を行う際のルールを定義します。

## 1. コミット戦略

### 原則
- **小さく頻繁にコミット**する
- 各コミットは**単一の責任**を持つ
- コミットメッセージは**具体的**に

### コミットのタイミング

#### ✅ コミットすべき粒度
1. **ファイル作成・削除時**
   - 新しいファイルを作成したらすぐコミット
   - ファイルを削除したらすぐコミット

2. **機能単位**
   - 1つのコンポーネント/関数/クラスを実装したらコミット
   - テストを追加/修正したらコミット
   - バグ修正を1つ完了したらコミット

3. **リファクタリング**
   - 1つのリファクタリングを完了したらコミット
   - 型定義の変更があったらコミット

4. **設定変更**
   - 設定ファイルの変更があったらコミット
   - 依存関係の追加/更新があったらコミット

#### ❌ コミットすべきでないタイミング
- 複数の無関係な変更をまとめてコミット
- テストが失敗している状態でコミット
- コンパイルエラーがある状態でコミット

### コミットメッセージ規約

```
<type>: <subject>

<body (optional)>

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

#### Type
- `feat`: 新機能
- `fix`: バグ修正
- `test`: テスト追加/修正
- `refactor`: リファクタリング
- `docs`: ドキュメント
- `style`: コードフォーマット
- `chore`: ビルド・設定等

#### 例
```
feat: add SavingsDisplay component

- Display total and monthly savings
- Format amounts with commas
- Handle negative values safely

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

## 2. PR（Pull Request）戦略

### 原則
- **小さく頻繁にPR**を作成する
- PRは**1つの機能/修正**に焦点を当てる
- レビューしやすいサイズを維持する（変更行数: 200-400行を目安）

### PRの作成タイミング

#### ✅ PRを作成すべきタイミング
1. **機能の完成**
   - 1つのコンポーネント/画面が完成したら
   - テストが全て通っていることを確認
   - Storybookストーリーも作成済み

2. **リファクタリング完了**
   - 大きなリファクタリングが完了したら
   - 既存テストが全て通っていることを確認

3. **バグ修正完了**
   - バグ修正とテストが完了したら
   - 再発防止のテストも追加済み

4. **ドキュメント更新**
   - 重要なドキュメントの追加/更新

#### ❌ PRを作成すべきでないタイミング
- 作業途中（WIP）の状態
  - Draft PRは可
- テストが失敗している状態
- 複数の無関係な機能をまとめたPR

### PR粒度の例

#### ✅ 良い粒度
- 「ホーム画面のコンポーネント実装」
- 「LocalStorageリポジトリの実装」
- 「ユーザープロフィールのユースケース実装」
- 「Storybook環境のセットアップ」

#### ❌ 悪い粒度
- 「Phase 1の全機能実装」（大きすぎる）
- 「typo修正とコンポーネント追加」（無関係な変更）
- 「テストが通らない状態のコード」（未完成）

### PRテンプレート

PRには以下を含める：

```markdown
## 概要
この変更の目的を簡潔に説明

## 実装内容
- 追加した機能
- 変更したファイル
- テスト内容

## テスト結果
`npm test` の結果を添付

## Story Mapping対応
- [ ] US-X.X: 対応するユーザーストーリー

## 動作確認方法
動作確認の手順

## スクリーンショット（必要に応じて）

🤖 Generated with [Claude Code](https://claude.com/claude-code)
```

## 3. レビュー依頼戦略

### 原則
- PRを作成したら**すぐにレビュー依頼**
- GitHub Copilotによる自動レビューを活用
- 必要に応じて人間のレビューも依頼

### レビュー依頼のタイミング

#### 自動的にレビュー依頼
1. PR作成直後
2. PR更新後（フィードバック対応後）

#### 人間のレビューが必要な場合
1. アーキテクチャ上の重要な決定
2. セキュリティに関わる変更
3. パフォーマンスに大きく影響する変更
4. 複雑なビジネスロジック

### レビュー対応
- フィードバックを受けたらすぐに対応
- 対応内容は**新しいコミット**として追加
- コミットメッセージに`fix: address review feedback`等を含める

## 4. ブランチ戦略

### ブランチ命名規則
```
<type>/<short-description>
```

#### Type
- `feature/`: 新機能
- `fix/`: バグ修正
- `refactor/`: リファクタリング
- `docs/`: ドキュメント
- `chore/`: 設定等

#### 例
- `feature/home-screen`
- `feature/savings-history`
- `fix/calculation-error`
- `refactor/repository-pattern`

### ブランチのライフサイクル
1. `main`から新しいブランチを作成
2. 小さなコミットを積み重ねる
3. 機能完成後、PRを作成
4. レビュー承認後、`main`にマージ
5. ブランチを削除

## 5. テスト戦略

### テストのタイミング
- **TDD（テスト駆動開発）**を採用
  1. テストを先に書く
  2. テストが失敗することを確認
  3. 実装を書いてテストを通す
  4. リファクタリング

### テストのカバレッジ
- 新しいコード: 必ずテストを書く
- 既存コード: バグ修正時にテストを追加
- エッジケース: 特に重要な部分は網羅的にテスト

### テストの種類
1. **ユニットテスト**
   - 各コンポーネント/関数/クラス
   - 正常系・異常系を網羅

2. **統合テスト**
   - コンポーネント間の連携
   - UseCaseとRepositoryの連携

3. **ビジュアルテスト**
   - Storybookストーリー
   - スナップショットテスト（必要に応じて）

## 6. 実装の順序

### 推奨される実装フロー

1. **設計・計画**
   - ファイル構造を決定
   - インターフェースを定義
   - テストケースを洗い出す

2. **テスト作成**
   - テストファイルを作成
   - テストケースを実装
   - コミット: `test: add tests for XComponent`

3. **実装**
   - 最小限の実装でテストを通す
   - コミット: `feat: implement XComponent`

4. **リファクタリング**
   - コードの改善
   - コミット: `refactor: improve XComponent readability`

5. **ドキュメント**
   - コメント・ドキュメントの追加
   - Storybookストーリーの作成
   - コミット: `docs: add XComponent documentation`

6. **PR作成・レビュー依頼**
   - PRを作成
   - すぐにレビュー依頼

## 7. 開発環境

### 必須チェック
- [ ] `npm test` が全て成功
- [ ] `npm run lint` でエラーがない
- [ ] `npm run build` が成功
- [ ] Storybookが正常に起動

### コミット前のチェックリスト
- [ ] テストが全て成功している
- [ ] 不要なコンソールログを削除
- [ ] コードフォーマットが整っている
- [ ] コミットメッセージが適切

### PR作成前のチェックリスト
- [ ] 全てのテストが成功
- [ ] ビルドが成功
- [ ] Storybookストーリーを作成（UIコンポーネントの場合）
- [ ] READMEや関連ドキュメントを更新（必要に応じて）
- [ ] PR説明文が完全

## 8. よくある質問

### Q: コミットが多すぎない？
A: 多すぎるくらいが丁度良いです。後から`git rebase`でまとめることもできますが、細かい履歴は貴重です。

### Q: PRのサイズが大きくなってしまった
A: 次回から機能を更に細分化しましょう。ただし、今回のPRはそのまま進めて問題ありません。

### Q: テストを後から書いてもいい？
A: 基本的にはTDDを推奨しますが、プロトタイピングの段階では実装優先でも構いません。ただし、PR作成前には必ずテストを書いてください。

### Q: Draft PRはいつ使う？
A: 作業中でフィードバックが欲しい時や、アプローチの妥当性を確認したい時に使用します。

## 9. 違反例と改善例

### ❌ 悪い例

#### コミット
```bash
git add .
git commit -m "update"
```
→ 何を変更したか不明

#### PR
- 3つの画面を1つのPRにまとめる
- テストが失敗している状態でPR作成
- PR説明が「実装しました」だけ

### ✅ 良い例

#### コミット
```bash
git add src/presentation/components/Home/SavingsDisplay.test.tsx
git commit -m "test: add SavingsDisplay component tests"

git add src/presentation/components/Home/SavingsDisplay.tsx
git commit -m "feat: implement SavingsDisplay component"
```

#### PR
- 1つのコンポーネントに絞ったPR
- 全テスト成功を確認
- 詳細なPR説明と動作確認方法を記載

## 10. このルールの運用

### ルールの更新
- プロジェクトの進行に伴い、このルールは適宜更新されます
- 重要な変更は必ずコミット履歴に残します

### ルール違反時の対応
- ルールに従っていないコミット/PRが作成された場合、次回から改善します
- 既存のコミット/PRは無理に修正せず、学びとして記録します

---

**このルールに従うことで、レビューしやすく、メンテナンスしやすいコードベースを維持できます。**
